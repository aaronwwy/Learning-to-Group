def evaluate(gt, res, ignore_labels):
    gt_map = dict()
    res_map = dict()
    res_inverted_index = dict()
    gt_inverted_index = dict()
    maxresid = 0

    for i in xrange(len(gt)):
        if gt[i] not in gt_map:
            gt_map[gt[i]] = list()
        gt_map[gt[i]].append(i)
        gt_inverted_index[i] = gt[i]

    for i in xrange(len(res)):
        if res[i] not in res_map:
            res_map[res[i]] = list()
        res_map[res[i]].append(i)
    maxresid = max(res)

    gtid2resid = dict()
    resid2gtid = dict()

    for res_key in res_map:
        if res_key in ignore_labels:
            continue
        res_facevector = res_map[res_key]
        gt_id_counter = dict()
        for facenumber in res_facevector:
            gt_id = gt_inverted_index[facenumber]
            if gt_id not in ignore_labels:
                if gt_id not in gt_id_counter:
                    gt_id_counter[gt_id] = 0
                gt_id_counter[gt_id] += 1
        if len(gt_id_counter) > 0:
            max_id = max(
                gt_id_counter.iterkeys(), key=lambda k: gt_id_counter[k])
            resid2gtid[res_key] = max_id
            if max_id not in gtid2resid:
                gtid2resid[max_id] = list()
            gtid2resid[max_id].append(res_key)

    unlabeled = list()
    total_delete_times = 0

    for res_key in res_map:
        if res_key not in resid2gtid:
            unlabeled += res_map[res_key]
        else:
            cleaned_facevector = list()
            gt_id = resid2gtid[res_key]
            for res_facenumber in res_map[res_key]:
                if gt_inverted_index[res_facenumber] != gt_id:
                    unlabeled.append(res_facenumber)
                    total_delete_times += 1
                else:
                    cleaned_facevector.append(res_facenumber)
            res_map[res_key] = cleaned_facevector

    # Now labeled sets are all cleaned

    total_add_times = 0

    for unlabeled_facenumber in unlabeled:
        gt_id = gt_inverted_index[unlabeled_facenumber]
        if gt_id not in ignore_labels:
            if gt_id in gtid2resid:
                res_id = gtid2resid[gt_id]
                res_map[res_id[0]].append(unlabeled_facenumber)
            else:
                maxresid += 1
                res_map[maxresid] = list()
                res_map[maxresid].append(unlabeled_facenumber)
                gtid2resid[gt_id] = list()
                gtid2resid[gt_id].append(maxresid)
            total_add_times += 1

    total_join_times = 0

    for gt_key in gt_map:
        if gt_key in ignore_labels:
            continue
        else:
            res_ids = gtid2resid[gt_key]
            total_join_times += len(res_ids) - 1
    # fout = open('test_operatenum', 'a')
    # fout.write(
    #     str(len(res)) + ' ' + str(total_delete_times) + ' ' +
    #     str(total_add_times) + ' ' + str(total_join_times) + '\n')
    # fout.close()

    score = 6 * total_delete_times + 1 * total_add_times + total_join_times
    # print 'Delete: ', total_delete_times, 'Add: ', total_add_times, 'Join: ', total_join_times
    return score


if __name__ == '__main__':
    gt_label = [
        6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,
        6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 19, 19, 19, 19, 19, 19, 19,
        19, 19, 19, 19, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 12, 12, 12,
        12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 8,
        8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,
        8, 8, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13,
        13, 13, 13, 13, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
        5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 21, 21,
        21, 21, 21, 21, 21, 21, 21, 21, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,
        7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
        7, 7, 7, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
        16, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14,
        14, 14, 14, 10, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
    ]
    res_label = [
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
        3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
        5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,
        6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
        7, 7, 7, 7, 7, 7, 7, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13,
        13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13,
        13, 13, 13, 13, 13, 13, 13, 13, 13, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9,
        9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
        10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11,
        11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12,
        12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 1, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 1, 1, 1, 1, 1, 2, 1, 2, 1, 1, 1, 1, 1, 1, 13, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1
    ]
    eval_result = evaluate(gt_label, res_label, [1, 2])
    print eval_result
